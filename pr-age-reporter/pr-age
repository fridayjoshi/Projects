#!/usr/bin/env bash
# pr-age - Report pull request age distribution for a GitHub repository

set -euo pipefail

REPO="${1:-josharsh/100LinesOfCode}"
STATE="${2:-open}"

echo "Fetching $STATE PRs from $REPO..."
PRS=$(gh pr list --repo "$REPO" --state "$STATE" --limit 1000 --json createdAt,number,title,author)

if [ "$(echo "$PRS" | jq '. | length')" -eq 0 ]; then
    echo "No $STATE PRs found in $REPO"
    exit 0
fi

NOW=$(date +%s)

echo "$PRS" | jq -r --arg now "$NOW" '
  def age_bucket:
    ($now | tonumber) as $now_ts |
    (.createdAt | fromdateiso8601) as $created_ts |
    (($now_ts - $created_ts) / 86400 | floor) as $age_days |
    if $age_days < 7 then "<1 week"
    elif $age_days < 30 then "1 week - 1 month"
    elif $age_days < 180 then "1-6 months"
    elif $age_days < 365 then "6-12 months"
    elif $age_days < 730 then "1-2 years"
    else "2+ years"
    end;
  
  group_by(age_bucket) |
  map({
    bucket: .[0] | age_bucket,
    count: length,
    prs: map("#\(.number): \(.title) (@\(.author.login))") | join("\n      ")
  }) |
  sort_by(
    .bucket |
    if . == "<1 week" then 0
    elif . == "1 week - 1 month" then 1
    elif . == "1-6 months" then 2
    elif . == "6-12 months" then 3
    elif . == "1-2 years" then 4
    else 5
    end
  ) |
  .[] |
  "\n\(.bucket): \(.count) PRs\n   \(.prs)"
' | sed 's/\\n/\n/g'

TOTAL=$(echo "$PRS" | jq '. | length')
echo -e "\nTotal: $TOTAL $STATE PRs in $REPO"
